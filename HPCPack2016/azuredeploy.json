{
  "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "clusterName": {
      "type": "string",
      "minLength": 3,
      "maxLength": 15,
      "metadata": {
        "description": "The name of the HPC cluster, also used as the head node name. It must contain between 3 and 15 characters with lowercase letters and numbers, and must start with a letter."
      }
    },
    "headNodeOS": {
      "type": "string",
      "defaultValue": "WindowsServer2012R2",
      "allowedValues": [
        "WindowsServer2012R2",
        "WindowsServer2016"
      ],
      "metadata": {
        "description": "The operating system of the head node."
      }
    },
    "headNodeVMSize": {
      "type": "string",
      "defaultValue": "Standard_DS2",
      "metadata": {
        "description": "The VM size for the head node, all available VM sizes in Azure can be found at https://azure.microsoft.com/en-us/documentation/articles/virtual-machines-windows-sizes."
      }
    },
    "computeNodeNamePrefix": {
      "type": "string",
      "defaultValue": "HPCNode",
      "minLength": 1,
      "maxLength": 12,
      "metadata": {
        "description": "The name prefix of the compute nodes. It must be no more than 12 characters, begin with a letter, and contain only letters, numbers and hyphens. For example, if 'IaaSCN' is specified, the compute node names will be 'IaaSCN000', 'IaaSCN001', ..."
      }
    },
    "computeNodeNumber": {
      "type": "int",
      "defaultValue": 2,
      "metadata": {
        "description": "The number of the compute nodes."
      }
    },
    "computeNodeOS": {
      "type": "string",
      "defaultValue": "WindowsServer2012R2",
      "allowedValues": [
        "WindowsServer2012R2",
        "WindowsServer2016"
      ],
      "metadata": {
        "description": "The operating system of the compute nodes."
      }
    },
    "computeNodeVMSize": {
      "type": "string",
      "defaultValue": "Standard_DS3",
      "metadata": {
        "description": "The VM size for the compute nodes, all available VM sizes in Azure can be found at https://azure.microsoft.com/en-us/documentation/articles/virtual-machines-windows-sizes."
      }
    },
    "adminUsername": {
      "type": "string",
      "defaultValue": "manager",
      "metadata": {
        "description": "Administrator user name for the virtual machines."
      }
    },
    "adminPassword": {
      "type": "securestring",
      "metadata": {
        "description": "Administrator password for the virtual machines."
      }
    },
    "hpcPackVersion": {
      "type": "string",
      "defaultValue": "latest",
      "metadata": {
        "description": "The version for HPC Pack 2016. It is strongly recommended to specify as 'latest'. The deployment will fail if an incorrect version is specified."
      }
    },
    "VaultInformation": {
      "type": "Securestring",
      "defaultValue": "[[[hpcpfxcert]]",
      "metadata": {
        "description": "Name of the KeyVault in which the certificate is stored."
      }
    },
    "vaultName": {
      "type": "string",
      "metadata": {
        "description": "Name of the KeyVault in which the certificate is stored."
      }
    },
    "vaultResourceGroup": {
      "type": "string",
      "metadata": {
        "description": "Resource Group of the KeyVault in which the certificate is stored."
      }
    },
    "certificateUrl": {
      "type": "string",
      "metadata": {
        "description": "Url of the certificate with version in KeyVault e.g. https://testault.vault.azure.net/secrets/testcert/b621es1db241e56a72d037479xab1r7."
      }
    },
    "certThumbprint": {
      "type": "string",
      "metadata": {
        "description": "Thumbprint of the certificate."
      }
    }
  },
  "variables": {
    "virtualNetworkName": "DevTestLabsVnetHPC",
    "subnet1Name": "default",
    "DevTestLabResourceGroupName": "DevTestLab",
    "apiVersion": "2015-06-15",
    "storageAccountType": "Standard_LRS",
    "storageAccountNameHN": "dpbjddemolab5270",
    "storageAccountIdHN": "[concat('/subscriptions/2deb88fe-eca8-499a-adb9-6e0ea8b6c1d2/resourceGroups/', variables('DevTestLabResourceGroupName'), '/providers/Microsoft.Storage/storageAccounts/',variables('storageAccountNameHN'))]",
    "cnStorageAccountNamePrefix": "[concat('hpc', uniqueString(resourceGroup().id, parameters('computeNodeNamePrefix')))]",
    "cnStorageAccountNumber": "[add(div(sub(parameters('computeNodeNumber'), 1), variables('nbrCNPerStorageAccount')), 1)]",
    "vnetID": "[concat('/subscriptions/2deb88fe-eca8-499a-adb9-6e0ea8b6c1d2/resourceGroups/', variables('DevTestLabResourceGroupName'), '/providers/Microsoft.Network/virtualNetworks/', variables('virtualNetworkName'))]",
    "subnetRef": "[concat('/subscriptions/2deb88fe-eca8-499a-adb9-6e0ea8b6c1d2/resourceGroups/', variables('DevTestLabResourceGroupName'), '/providers/Microsoft.Network/virtualNetworks/', variables('virtualNetworkName'), '/subnets/', variables('subnet1Name'))]",
    "availabilitySetNameHN": "[concat(parameters('clusterName'), '-avset')]",
    "cnAvailabilitySetNamePrefix": "[concat(parameters('computeNodeNamePrefix'), 'avset')]",
    "nbrVMPerAvailabilitySet": 80,
    "cnAvailabilitySetNumber": "[add(div(parameters('computeNodeNumber'), variables('nbrVMPerAvailabilitySet')), 1)]",
    "uniqueSuffix": "[uniqueString(variables('subnetRef'))]",
    "uniqueNicSuffix": "[concat('-nic-', variables('uniqueSuffix'))]",
    "nicNameHN": "[concat(parameters('clusterName'), variables('uniqueNicSuffix'))]",
    "vmSizeSuffix": "[uniqueString(resourceGroup().id)]",
    "suffixHNSize": "[concat(parameters('headNodeVMSize'), variables('vmSizeSuffix'))]",
    "suffixCNSize": "[concat(parameters('computeNodeVMSize'), variables('vmSizeSuffix'))]",
    "suffixA8Size": "[concat('Standard_A8', variables('vmSizeSuffix'))]",
    "suffixA9Size": "[concat('Standard_A9', variables('vmSizeSuffix'))]",
    "cnRDMASuffix": "[replace(replace(replace(variables('suffixCNSize'), variables('suffixA8Size'),'-rdma'), variables('suffixA9Size'),'-rdma'),variables('suffixCNSize'), '')]",
    "hnRDMASuffix": "[replace(replace(replace(variables('suffixHNSize'), variables('suffixA8Size'),'-rdma'), variables('suffixA9Size'),'-rdma'),variables('suffixHNSize'), '')]",
    "nbrCNPerStorageAccount": 30,
    "certSecrets": [
      {
        "sourceVault": {
          "id": "[resourceId(parameters('vaultResourceGroup'), 'Microsoft.KeyVault/vaults', parameters('vaultName'))]"
        },
        "vaultCertificates": [
          {
            "certificateUrl": "[parameters('certificateUrl')]",
            "certificateStore": "My"
          }
        ]
      }
    ],
    "headNodeImages": {
      "WindowsServer2012R2": {
        "publisher": "MicrosoftWindowsServerHPCPack",
        "offer": "WindowsServerHPCPack",
        "sku": "2016HN-WS2012R2",
        "version": "[parameters('hpcPackVersion')]"
      },
      "WindowsServer2016": {
        "publisher": "MicrosoftWindowsServerHPCPack",
        "offer": "WindowsServerHPCPack",
        "sku": "2016HN-WS2016",
        "version": "[parameters('hpcPackVersion')]"
      }
    },
    "computeNodeImages": {
      "WindowsServer2012R2": {
        "publisher": "MicrosoftWindowsServerHPCPack",
        "offer": "WindowsServerHPCPack",
        "sku": "2016CN-WS2012R2",
        "version": "[parameters('hpcPackVersion')]"
      },
      "WindowsServer2016": {
        "publisher": "MicrosoftWindowsServerHPCPack",
        "offer": "WindowsServerHPCPack",
        "sku": "2016CN-WS2016",
        "version": "[parameters('hpcPackVersion')]"
      }
    },
    "headNodeImageRef": "[variables('headNodeImages')[parameters('headNodeOS')]]",
    "computeNodeImageRef": "[variables('computeNodeImages')[parameters('computeNodeOS')]]",
    "sharedResxBaseUrl": "https://raw.githubusercontent.com/MsHpcPack/HPCPack2016/master/newcluster-templates/shared-resources"
  },
  "resources": [
  ],
  "outputs": {
    "KeyVault": {
      "type": "string",
      "value": "[variables('VaultInformation')]"
    }
  }
}